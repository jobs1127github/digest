<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>编辑资讯</title>
<!-- 不允许浏览器缓存的三句话 -->
<meta http-equiv="pragma" content="no-cache">
<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="expires" content="0">

<meta http-equiv="description" content="This is my page">

<link href="../css/table.css" rel="stylesheet" type="text/css" />
<link href="../css/global.css" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="../javascript/jquery-1.6.4.min.js"></script>
<script type="text/javascript" src="../javascript/jquery.alerts.js"></script>
<script type="text/javascript" src="../javascript/calendar.js"></script>
<script type="text/javascript" src="../javascript/httpService.js"></script>
<script type="text/javascript" src="../javascript/page.js"></script>
<script type="text/javascript" src="../javascript/validata.js"></script>
<script type="text/javascript" src="../javascript/jquery.datepick.js"></script>
<script type="text/javascript" src="../javascript/jquery.datepick-zh-CN.js"></script>
<script type="text/javascript" src="../javascript/window.js"></script>

<link type="text/css" href="../css/smoothness.datepick.css" rel="stylesheet" />
<!-- 删除已经上传的单个文件的公共方法 -->
<script type="text/javascript" src="../javascript/public.js"></script>
<script type="text/javascript" src="../javascript/loadSelects.js"></script>
<script type="text/javascript" src="../javascript/toPingYin.js"></script>

<link href="../uploadify/uploadify.css" rel="stylesheet" type="text/css">
<script src="../js/common.js"></script>
<base target="_self">


<!-- 文件上传相关的插件 start
	基于jquery的文件上传控件，支持ajax无刷新上传，多个文件同时上传，上传进行进度显示，删除已上传文件。 -->
<script type="text/javascript" src="../uploadify/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="../uploadify/swfobject.js"></script>
<script type="text/javascript" src="../uploadify/jquery.uploadify.v2.1.4.js"></script>
<script type="text/javascript" src="../uploadify/jquery.uploadify.v2.1.4.min.js"></script>
<!-- 文件上传相关的插件 end-->


<!--layer是一款近年来备受青睐的web弹层组件，她具备全方位的解决方案，
	致力于服务各水平段的开发人员，您的页面会轻松地拥有丰富友好的操作体验。
	参考网站：http://layer.layui.com/ -->
<script src="../js/lib/layer-v2.1/layer/layer.js"></script>


<!-- kindeditor编辑器相关js start-->
<script charset="utf-8" src="../js/lib/kindeditor-4.1.10/kindeditor.js"></script>
<script charset="utf-8" src="../js/lib/kindeditor-4.1.10/lang/zh_CN.js"></script>
<script charset="utf-8" src="../js/lib/kindeditor-4.1.10/plugins/media/media.js"></script>
<link rel="stylesheet" href="../js/lib/kindeditor-4.1.10/themes/default/default.css" type="text/css"/>
<link rel="stylesheet" href="../js/lib/kindeditor-4.1.10/plugins/code/prettify.css" type="text/css"/>
<script charset="utf-8" src="../js/lib/kindeditor-4.1.10/kindeditor-all.js" type="text/javascript"></script>
<script charset="utf-8" src="../js/lib/kindeditor-4.1.10/plugins/code/prettify.js" type="text/javascript"></script>
<!-- kindeditor编辑器相关js end-->

        

</head>

<script>
	/**
	编辑器 参考：http://www.sucaihuo.com/js/123.html
	KindEditor 是一套开源的在线HTML编辑器，主要用于让用户在网站上获得所见即所得编辑效果，
	开发人员可以用 KindEditor 把传统的多行文本输入框(textarea)替换为可视化的富文本输入框。
	**/
	KindEditor.ready(function(K) {
		//#editor_id编辑器显示的<textarea id="editor_id"></textarea>对应的id元素
		$.editor = window.editor = K.create('#editor_id',
		{
			//上传文件时调用,指定上传文件的服务器端程序。
			uploadJson:pageContextPath + '/information/upload.do',
			//指定浏览远程图片的服务器端程序。
			//fileManagerJson:pageContextPath+'/information/resourcesManage.do',
			//true或false，true时显示浏览服务器图片功能。
			allowImageUpload:true,//允许上传图片
			//编辑器的宽度，可以设置px或%，比TEXTAREA输入框样式表宽度优先度高。
			width : '100%',
			//编辑器的高度，只能设置px，比TEXTAREA输入框样式表高度优先度高。
			height : '500px',
			//数据类型：Boolean 。true时过滤HTML代码，false时允许输入任何代码。
			//filterMode:false,
			//数据类型：Object。指定要保留的HTML标记和属性。哈希数组的key为HTML标签名，value为HTML属性数组
			//htmlTags:{ font : ['color', 'size', 'face', '.background-color'], span : ['style'], div : ['class', 'align', 'style'], table: ['class', 'border', 'cellspacing', 'cellpadding', 'width', 'height', 'align', 'style'], 'td,th': ['class', 'align', 'valign', 'width', 'height', 'colspan', 'rowspan', 'bgcolor', 'style'], a : ['class', 'href', 'target', 'name', 'style'], embed : ['src', 'width', 'height', 'type', 'loop', 'autostart', 'quality', 'style', 'align', 'allowscriptaccess', '/'], img : ['src', 'width', 'height', 'border', 'alt', 'title', 'align', 'style', '/'], hr : ['class', '/'], br : ['/'], 'p,ol,ul,li,blockquote,h1,h2,h3,h4,h5,h6' : ['align', 'style'], 'tbody,tr,strong,b,sub,sup,em,i,u,strike' : [] },
			//2或1或0，2时可以拖动改变宽度和高度，1时只能改变高度，0时不能拖动。
			resizeMode:2,
			//数据类型：Boolean。可视化模式或代码模式
			//wyswygMode:true,
			//afterUpload:function(){this.sync();},
			//afterBlur:function(){this.sync();},
			//items	配置编辑器的工具栏
			items : ['source', '|', 'fullscreen', 'undo', 'redo', 
			         'print', 'cut', 'copy', 'paste', 'plainpaste', 
			         'wordpaste', '|', 'justifyleft', 'justifycenter', 
			         'justifyright', 'justifyfull', 'insertorderedlist', 
			         'insertunorderedlist', 'indent', 'outdent', 'subscript', 
			         'superscript', '|', 'selectall', '-', 'title', 'fontname', 
			         'fontsize', '|', 'textcolor', 'bgcolor', 'bold', 'italic', 
			         'underline', 'strikethrough', 'removeformat', '|', 'image', 
			         'flash', 'media', 'advtable', 'hr', 'emoticons', 'link', 
			         'unlink', '|', 'about']
		});
	});


	//获取地址栏?后的参数
	function getQueryString(name) {
		var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
		var r = window.location.search.substr(1).match(reg);
		if (r != null)
			return unescape(r[2]);
		return null;
	}
	
	$(function() {
		//获取传递过来的参数
		var information_id = getQueryString("information_id");
		
		//资讯类别列表
		sendRequest(pageContextPath + "/system/loadinitDatas.do", {
			"param" : "informationType"
		}, function(jsonData) {
			var data1 = jsonData.data;
			$("#information_type").empty();
			for ( var i = 0; i < data1.length; i++) {
				$("#information_type").append(
						"<option value='"+data1[i].dataItem+"'>"
								+ data1[i].dataValue + "</option>");
			}
		}, false);

		//专家列表
		sendRequest(pageContextPath + "/system/loadinitExpert.do", {},
				function(jsonData) {
					var data1 = jsonData.data;
					$("#openid").empty();
					for ( var i = 0; i < data1.length; i++) {
						$("#openid").append(
								"<option value='"+data1[i].dataItem+"'>"
										+ data1[i].dataValue + "</option>");
					}
				}, false);
	});

	function updateInformation() {
		if ($("#title").val().trim() == "") {
			alert("资讯名称为空");
			$("#title").focus();
			return;
		}

		if ($("#openid").val().trim() == "") {
			alert("作者不能为空");
			$("#openid").focus();
			return;
		}
		/*
		if (typeof ($('input:[name="mark"]:checked').val()) == "undefined") {
			alert("标签不能为空");
			return;
		}
		*/
		var content = editor.html();
		if (content == "") {
			alert("资讯内容不能为空");
			return;
		}
		$("#content").val(content);
		var params = $("#informationFrom").serialize();
		sendRequest(pageContextPath + "/information/updateInformations.do",
				params, function(jsonData) {
					if (jsonData.data) {
						alert("编辑成功");
						window.opener.location.reload(true);
						window.close();
					} else {
						alert("编辑失败!请联系管理员");
					}
				}, false);

	}
	/**
		获取要编辑的资讯文章，初始化回显数据，
		$("#tile_img_url").val(data.tile_img_url);
		$("#audio_url").val(data.audio_url);
		如果用户没有上传图片，则使用之前的
	**/
	function init() {
		var information_id = getQueryString("information_id");
		$("#information_id").val(information_id);
		sendRequest(
				pageContextPath + "/information/queryInformationById.do",
				{
					"information_id" : information_id
				},
				function(jsonData) {
					var data = jsonData.data;
					$("#title").val(data.title);
					$("#introduce").val(data.introduce);
					$("#tile_img_url").val(data.tile_img_url);
					$("#audio_url").val(data.audio_url);
					$("#information_type").val(data.information_type);
					$("#openid").val(data.openid);
					$("#status").val(data.status);
					$("#best_flag").val(data.best_flag);
					
					editor.html(data.content);
					var Str_mark = data.mark + ",";
					//alert("Str_mark="+Str_mark);
					var sourceStrArray = Str_mark.split("/,");
					$("#zxmark").html("");
					sendRequest(pageContextPath + "/system/loadinitMark.do", {
						"mark" : ""
					}, function(jsonData) {
						markMap = jsonData.data;
						var mark = "";
						for ( var i = 0; i < markMap.length; i++) {
							var q = false;
							for ( var j = 0; j < sourceStrArray.length; j++) {
								var checkedmark = sourceStrArray[j];
								var loadmark = markMap[i].dataItem;
								if (loadmark == checkedmark) {
									q = true;
								}
							}
							if (q) {
								mark += "<input type='checkbox' checked ='checked' name='mark' value="+markMap[i].dataItem+"/>"
										+ markMap[i].dataValue + "&nbsp";
							} else {
								mark += "<input type='checkbox'  name='mark' value="+markMap[i].dataItem+"/>"
										+ markMap[i].dataValue + "&nbsp";
							}
						}
						$("#zxmark").html(mark);
					}, false);
			}, false);
	}
</script>

<script type="text/javascript">
	/***
		文件上传，使用uploadify插件，上传标题和专家录音
	**/
	$(document).ready(function() {
		/**
		<input type="file" name="uploadify" id="uploadify"/>
		$("#uploadify")的uploadify为上面元素的id
		**/
		$("#uploadify").uploadify({
			'uploader' : "../uploadify/uploadify.swf",//flash文件位置，注意路径
			'script' : "upload/Upload",//点击上传后调用的servlet程序,后台处理的请求
			'cancelImg' : "../uploadify/cancel.png",//取消按钮图片
			//'folder' : "uploads",//您想将文件保存到的路径,上传文件存放的路径,请保持与uploadFile.jsp中PATH的值相同
			'progressData' : "percentage",
			'queueId' : "fileQueue_img",//与下面的上传文件列表id对应
			'queueSizeLimit' : 1,//限制上传文件的数量
			'fileDesc' : "请选择jpg文件",//上传文件类型说明
			'fileExt' : "*.jpg",//限制文件类型,//控制可上传文件的扩展名，启用本项时需同时声明fileDesc
			'auto' : true,//是否自动上传
			'multi' : false,//是否允许多文件上传
			'simUploadLimit' : 1,//同时运行上传的进程数量,同时上传文件的数量
			'removeCompleted' : false,
			'buttonImg' : "../uploadify/bat.png",
			'buttonText' : "files",//浏览按钮图片
			//scriptData这个参数用于传递用户自己的参数，此时'method'必须设置为GET,后台可以用request.getParameter('name')获取名字的值
			'scriptData' : {
				'type' : '2' //type为用户自定义的参数，使用了这个自定义的参数，则需要method为get
			},
			//'scriptData':{'a':'value1','b':'value2'},//向后台传的数据
			'method' : "GET",//如果向后台传输数据，必须是get
			'sizeLimit':50*1024*1024,//文件上传的大小限制，单位是字节,限制在50M之内
			//当上传完成后，再取消后的回调函数。
			'onCancel' : function() {
				alert('正准备取消上传!!!');
			},
			//全部完成后的回调函数，ajax方式。
			'onAllComplete' : function() {
			},
			//当上传完成后的回调函数，ajax方式。
			'onComplete' : function(event, queueId, fileObj, response, data) {
				$("#tile_img_url").val(response);
				//$("#title_img").src=response;
				//alert("response="+response);
				//alert("src="+$("#title_img").src);
				var h = '<img id="title_img" alt="a" src="'+response+'" width="50" height="50">';
				$("#nima").html(h);
			}
		});
		/**
		<input type="file" name="Auploadify" id="Auploadify"/>
		$("#Auploadify")的Auploadify为上面元素的id
		**/
		$("#Auploadify").uploadify({
			'uploader' : "../uploadify/uploadify.swf",
			'script' : "upload/Upload",
			'cancelImg' : "../uploadify/cancel.png",
			'folder' : "uploads",//上传文件存放的路径,请保持与uploadFile.jsp中PATH的值相同
			'progressData' : "percentage",
			'queueId' : "fileQueue_audio",
			'queueSizeLimit' : 1,//限制上传文件的数量
			'fileDesc' : "请选择mp3文件",
			'fileExt' : "*.mp3",//限制文件类型
			'auto' : true,
			'multi' : false,//是否允许多文件上传
			'simUploadLimit' : 1,//同时运行上传的进程数量
			'removeCompleted' : false,
			'buttonImg' : "../uploadify/bat.png",
			'buttonText' : "files",
			//这个参数用于传递用户自己的参数，此时'method' 必须设置为GET, 后台可以用request.getParameter('name')获取名字的值
			'scriptData' : {
				'type' : '1'
			},
			'method' : "GET",
			'onCancel' : function() {
				alert('正准备取消上传!!!');
			},
			'onAllComplete' : function() {
			},
			'onComplete' : function(event, queueId, fileObj, response, data) {
				$("#audio_url").val(response);
			}
		});
	});
</script>

<body style='overflow: scroll; overflow-x: hidden' onload="init();">
	<div style="margin-bottom: 10px;">
		<img src="../images/t.png" /> <span style="font-size: 18px;">编辑资讯</span>
	</div>
	<form id="informationFrom" name="informationFrom" method="post">
		<input type="hidden" name="information_id" id="information_id" /> 
		<input type="hidden" name="status" id="status" /> 
		<input type="hidden" id="content" name='content' />
		
		<div style="position: relative;">
			<fieldset>
				<legend>
					<strong>资讯信息</strong>
				</legend>
				<table id="AddTable">
					<tr>
						<td>名称<a style="color: red;">*</a></td>
						<td><input style="width: 400px;" type="text" name="title" id="title" /></td>
					</tr>
					<tr>
						<td>标题<a style="color: red;"></a></td>
						<td>
						<input type="hidden" id="tile_img_url" name="tile_img_url" />
							<a style="color: red;">请上传1:1比例的jpg格式图片</a>
							<div id="fileQueue_img">
								<input type="file" name="uploadify" id="uploadify"/>
							</div>
						<div id="nima"></div>
						</td>
						
						<td>专家录音<a style="color: red;"></a></td>
						<td>
						<input type="hidden" id="audio_url" name="audio_url"/>
						<a style="color: red;">请上传pm3格式音频</a>
							<div id="fileQueue_audio">
								<input type="file" name="Auploadify" id="Auploadify"/>
							</div>
						</td>
					</tr>
					
					<tr>
						<td>内容<a style="color: red;">*</a></td>
						<td colspan="3">
							<textarea id="editor_id"></textarea>
						</td>
					</tr>
					
					<tr>
						<td>类别<a style="color: red;">*</a></td>
						<td>
						<select id="information_type" name="information_type" style="width:150px">
						</select>
						</td>
						<td>作者<a style="color: red;">*</a></td>
						<td><select id="openid" name="openid" style="width:150px">
						</select></td>
					</tr>
					<tr>
						<td>标签<a style="color: red;">*</a></td>
						<td colspan="3" id="zxmark"></td>
					</tr>
					<tr>
						<td>精选</td>
						<td>
						<select id="best_flag" name="best_flag" class="select"
							style="width:153px;">
								<option value="0" selected="selected">--</option>
								<option value="Y">前台图片轮播/6个固定模块</option>
								<option value="N">前台6个列表</option>	
						</select>
						</td>
					</tr>
				</table>
			</fieldset>
		</div>
		<br /> <br />
		<div style="float: left; text-align: center; margin-left: 302.5px;">
			<a href="#" onclick="updateInformation()"><div class="btns1">保存</div>
			</a> <a href="#" onclick="window.close()"><div class="btns1">关闭</div>
			</a>
		</div>
	</form>
	<br>
	<br>
</body>


</html>